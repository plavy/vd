<!doctype html>

<html>

<head>
    <title>Graph</title>
    <link rel="stylesheet" type="text/css" rel="noopener" target="_blank" href="styles.css">

    <script src="dagre.min.js"></script>
    <script src="cytoscape.min.js"></script>
    <script src="cytoscape-dagre.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <script src="datasets.js"></script>

</head>


<body>
    <div id="right-panel">
        <label for="histogram">Number of neighbours per class</label>
        <canvas id="histogram" style="width:100%;max-width:600px"></canvas>
    </div>

    <div id="control-bar">
        <label for="dataset-select">Dataset</label>
        <select name="datasets" id="select-dataset">
        </select>

        <label for="nodesA-color">Nodes A:</label>
        <input type="color" id="nodesA-color" value="#ff0000"/>
        <label for="nodesB-color">Nodes B:</label>
        <input type="color" id="nodesB-color" value="#008800"/>
        <label for="nodesC-color">Nodes C:</label>
        <input type="color" id="nodesC-color" value="#0000ff"/>


        <button id="reset-zoom" type="button">Zoom to fit</button>

    </div>

    <div id="cy"></div>

    <script>
        const K = 3

        // Initialize dataset list
        selectDataset = document.getElementById('select-dataset');
        for (var i = 0; i < datasets.length; i++) {
            var opt = document.createElement('option');
            opt.value = i;
            opt.innerHTML = datasets[i].name;
            selectDataset.appendChild(opt);
        }

        var cy = cytoscape({
            container: document.getElementById('cy'),
            elements: datasets[0], // from datasets.js
            style: [
                {
                    selector: 'node',
                    style: {
                        shape: 'ellipse',
                        label: 'data(id)',
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'line-color': '#ccc',
                        'target-arrow-color': '#ccc',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier'
                    }
                },
                {
                    selector: ':selected',
                    css: {
                        'line-color': 'black',
                        'target-arrow-color': 'black',
                        'border-width': 4,
                        'border-color': 'black'
                    }
                }],
            wheelSensitivity: 0.1
        });

        var hist = new Chart("histogram", {
            type: "bar",
            data: {
                labels: [],
                datasets: [{
                    data: []
                }]
            },
            options: {
                legend: { display: false },
                onHover: (event, element) => {
                    if (element.length == 1) {
                        event.target.style.cursor = 'pointer';
                    } else {
                        event.target.style.cursor = 'default';
                    }
                },
                scales: {
                    xAxes: [{
                        gridLines: {
                            color: "rgba(0, 0, 0, 0)"
                        }
                    }],
                    yAxes: [{
                        ticks: { min: 0 },
                        gridLines: {
                            color: "rgba(0, 0, 0, 0)"
                        }
                    }],

                }
            }
        });
        document.getElementById("histogram").onclick = function (evt) {
            var points = hist.getElementsAtEventForMode(evt, 'nearest', {
                intersect: true
            }, true);
            if (points.length) {
                setSelected(points[0]._index);
            }
        };


        function changeColor(event) {
            let nodes = cy.nodes(".group0");
            nodes.forEach(function (node) {
                node.style("background-color", event.target.value);
            });
        }

        function resetZoom(event) {
            cy.fit();
        }

        function setSelected(index) {
            cy.nodes().unselect();
            cy.nodes(".group" + index).select();
        }

        function updateDataset(event) {
            cy.json({ elements: newEleJsons });
        }

        document.getElementById("nodesA-color").addEventListener('change', (event) => updateColor(0, event.target.value));
        document.getElementById("nodesB-color").addEventListener('change', (event) => updateColor(1, event.target.value));
        document.getElementById("nodesC-color").addEventListener('change', (event) => updateColor(2, event.target.value));
        document.getElementById("reset-zoom").addEventListener('click', resetZoom);
        document.getElementById("select-dataset").addEventListener('change', (event) => {
            cy.json({ elements: datasets[event.target.value] });
            refreshGraphs();
        })

        function refreshGraphs() {
            cy.layout({
                name: 'dagre'
            }).run();

            hist.data.datasets = []
            let count = new Array(K)
            for (var i = 0; i < K; i++) {
                count[i] = 0
                cy.nodes(".group" + i).forEach((node) => count[i] += node.neighborhood().nodes().length);
            }
            hist.data.labels = ["A", "B", "C"];
            hist.data.datasets = [{
                data: count,
                backgroundColor: ["#ff0000", "#008800", "#0000ff"]
            }]
            hist.update();
            updateColor(0, document.getElementById("nodesA-color").value)
            updateColor(1, document.getElementById("nodesB-color").value)
            updateColor(2, document.getElementById("nodesC-color").value)
        }

        function updateColor(index, color) {
            hist.data.datasets[0].backgroundColor[index] = color
            hist.update()
            cy.nodes(".group" + index).forEach((node) => node.style("background-color", color));
        }


        refreshGraphs()
        updateColor()
    </script>
</body>

</html>